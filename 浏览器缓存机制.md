## **浏览器缓存机制**

##### 什么是浏览器缓存？

> 简单来说,浏览器缓存其实就是浏览器保存通过HTTP获取的所有资源,是浏览器将网络资源存储在本地的一种行为。

##### 缓存资源存储的地方

##### memory cache

> MemoryCache顾名思义，就是将资源缓存到内存中，等待下次访问时不需要重新下载资源，而直接从内存中获取。Webkit早已支持memoryCache。 目前Webkit资源分成两类，一类是主资源，比如HTML页面，或者下载项，一类是派生资源，比如HTML页面中内嵌的图片或者脚本链接，分别对应代码中两个类：MainResourceLoader和SubresourceLoader。虽然Webkit支持memoryCache，但是也只是针对派生资源，它对应的类为CachedResource，用于保存原始数据（比如CSS，JS等），以及解码过的图片数据。

##### disk cache

> DiskCache顾名思义，就是将资源缓存到磁盘中，等待下次访问时不需要重新下载资源，而直接从磁盘中获取，它的直接操作对象为CurlCacheManager。

##### 访问缓存优先级

> 1. 先在内存中查找,如果有,直接加载。
> 2. 如果内存中不存在,则在硬盘中查找,如果有直接加载。
> 3. 如果硬盘中也没有,那么就进行网络请求。
> 4. 请求获取的资源缓存到硬盘和内存

##### 缓存分类

> 强缓存和协商缓存
>
> 强缓存：浏览器在加载资源时，会先根据本地缓存资源的 header 中的信息判断是否命中强缓存，如果命中则直接使用缓存中的资源不会再向服务器发送请求。
>
> 协商缓存：浏览器在加载资源时，会发送一个请求到服务器，服务器根据 header 中的部分信息来判断是否命中缓存。如果命中，则返回 304 ，告诉浏览器资源未更新，可使用本地的缓存。

##### 强缓存

> 使用 **Expires**、**Cache-Control** 来判断缓存是否可用
>
> **Expires**： http1.0 时的规范，它的值为一个绝对时间的 GMT 格式的时间字符串，比如 Expires:Mon,18 Oct 2066 23:59:59 GMT。这个时间代表着这个资源的失效时间，在此时间之前，即命中缓存。这种方式的缺点，1、由于失效时间是一个绝对时间，所以当服务器与客户端时间偏差较大时，就会导致缓存混乱。2、缓存过期后，服务器还得重新设定新的过期时间。
>
> **Cache-Control**：**http1.1** 时出现的 header 信息，主要是利用该字段的 max-age 值来进行判断，它是一个相对时间，例如 Cache-Control:max-age=3600，代表着资源的有效期是 3600 秒。cache-control 除了该字段外，还有下面几个比较常用的设置值
>
> **public**：所有内容都将被缓存(客户端和代理服务器都可缓存)。
>
> **private**：内容只缓存到私有缓存中(仅客户端可以缓存，代理服务器不可缓存)
>
> **no-cache**：需要进行协商缓存，发送请求到服务器确认是否使用缓存。
>
> Cache-Control 与 Expires 可以在服务端配置同时启用，同时启用的时候 Cache-Control 优先级高。

##### 协商缓存

> 使用  **Last-Modify / If-Modify-Since** 和 **ETag / If-None-Match** 来判断缓存是否可用
>
> **Last-Modify**：是服务器响应请求时，返回该资源文件在服务器最后被修改的时间
>
> **If-Modified-Since**：则是客户端再次发起该请求时，携带上次请求返回的Last-Modified值，通过此字段值告诉服务器该资源上次请求返回的最后被修改时间。服务器收到该请求，发现请求头含有If-Modified-Since字段，则会根据If-Modified-Since的字段值与该资源在服务器的最后被修改时间做对比，若服务器的资源最后被修改时间大于If-Modified-Since的字段值，则重新返回资源，状态码为200；否则则返回304，代表资源无更新，可继续使用缓存文件。
>
> **Etag**：是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)。
>
> **If-None-Match**：是客户端再次发起该请求时，携带上次请求返回的唯一标识Etag值，通过此字段值告诉服务器该资源上次请求返回的唯一标识值。服务器收到该请求后，发现该请求头中含有If-None-Match，则会根据If-None-Match的字段值与该资源在服务器的Etag值做对比，一致则返回304，代表资源无更新，继续使用缓存文件；不一致则重新返回资源文件，状态码为200。
>
> **Last-Modified 与 ETag 是可以一起使用的，服务器会优先验证 ETag，一致的情况下，才会继续比对 Last-Modified**

##### 浏览器缓存总体流程

![](C:\Users\huangweiming\Desktop\408483-20160525182943272-204994049.png)
